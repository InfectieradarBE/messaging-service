# Email templates
This page contains some useful information around the email template topic, e.g., how to include variables, which message types should be used for what and how to construct links in the email using variables.

## Message Types
Required message types for system messages:
- **registration**: when a new account is created, this message will be sent to the used email address. This message should include link to email verification route including the token (see below).
- **invitation**: this email is sent out when a user account was created by an admin. This message should include link to invite link route including the token (see below).
- **verify-email**: if a user requests a new verification email, or in case the email address is changed in the application, this email will be sent out. Should also contain the specific link for email verification.
- **password-reset**: after triggering the password reset workflow, this email-template will be used. Should contain link with url toward the password reset link resolver of the web-client, including the appropriate token (see below).
- **verification-code**: After login, the user will receive this message, that should include the 6 digit numeric code prominently.
See below how to access the variable.
- **password-changed**: after a successful password change, the user will receive an email about the event. This template needs to define the content of this email.
- **accound-id-changed**: when a user changes the email address in the application, this message will be sent to the *old* email address. Can be used to warn about potential inappropriate access, or tell the user to use the new email to login.
- **account-deleted**: as a last contact, this message will be sent out to confirm the successful account deletion.

The sending of these messages is typically triggered automatically after a specific event occured in the system. These messages will be sent over the "high prio" email server, since delivery speed is here essential.


Supported message types for bulk email sending:

- **weekly**: to send regular weekly reminder / summary for users/participants - typically with a link to the study page, including a login token, to automatically confirm email possession.
- **study-reminder**: to send occasional reminder that a survey in a specific study is available - typically with a link to the study page, including a login token, to automatically confirm email possession.
- **newsletter**: send regular or irregular news-like emails to the users / study participants - this does not contain a login token, just informations, and possibly links to the result pages


## Accessing variables
The email templates will be resolved by the go templating engine. A map (map{string}string) is passed down to template resolution containing relevant variables.
To access a value from this map, you can use the following command in your html template:
```
{{index . "<your-variable-name>"}}
```
For example, to access the verification code, you can use:
```
{{index . "verificationCode"}}
```

Following variables are supported at the moment:
- **loginToken**: can be used to verfiy possession of the email address (one factor in the multi step login).
- **verificationCode**: 6 digit verification code (one factor of the multi step login).
- **studyKey**: key of the study, we sending out the message for.
- **unsubscribeToken**: can be used to unsubscribe from newletter
- **token**: random token string, that can be used to access the system - generated by the user-management for a specific purpose.
- **language**: user's preferred language selection.


## Possible URL routes
At the moment, email links should point to the web-application, which will resolve the subroutes.

```
https://<webapp-url>/<subroute>
```

Possible *subroutes* are:
- `/link/study-login?token=<loginToken>&study=<studykey>` - use this link to open the study page directly.
- `/link/verify-contact?token=<token>`: - use this link to confirm email address, e.g., after registration or when the email address has been changed.
- `/link/password-reset?token=<token>`: at this link with the appropriate token, the password reset workflow is triggered (you verified possession of the email address).
- `/link/invitation?token=<token>`: this link is to confirm the invitation - verifying email address and starting password reset workflow.


<- For the notion `<variable>`, see the section before how to access variables.

To use automatic language selection, when opening an email, use the `?lang=<language code>` URL query parameter.

Finally, an example url route with variables could look like this:
```
https://app.participant-app.com/link/study-login?token={{index . "loginToken"}}

https://app.participant-app.com/link/verify-contact?token={{index . "token"}}

https://app.participant-app.com/link/password-reset?token={{index . "token"}}
```

You can use these links as normal text or as the value for the `href` attribute of a link in html.
